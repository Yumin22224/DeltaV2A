# Stage 1: Audio-only Control Learning
# Learn S_proxy space and head specialization

defaults:
  - default

stage: 1
stage_name: "audio_control_learning"

# Data for Stage 1
data:
  # Stage 1-A: Synthetic warmup
  synthetic:
    dataset_path: "${project.data_dir}/synthetic_pairs"
    num_samples: 2000
    batch_size: 16

  # Stage 1-B: Remix fine-tuning
  remix:
    dataset_path: "${project.data_dir}/remix_pairs"
    num_samples: 1000
    batch_size: 16

# Training phases
training:
  # Phase 1-A: Synthetic
  phase_1a:
    epochs: 50
    learning_rate: 1.0e-4
    loss_weights:
      recon: 1.0
      struct: 0.5
      rank: 1.0  # Strong rank consistency

  # Phase 1-B: Remix
  phase_1b:
    epochs: 30
    learning_rate: 5.0e-5
    loss_weights:
      recon: 1.0
      struct: 0.5
      rank: 0.5  # Weaker rank consistency

# Model components
model:
  # S Encoder
  s_encoder:
    backbone: "resnet18"
    in_channels: 2  # concat(mel_init, mel_edit)
    hidden_dim: 512
    num_heads: 6
    head_output_dim: 65  # 64 (t_h) + 1 (g_h)

  # Audio Generator
  audio_generator:
    load_pretrained: true
    pretrained_path: null  # Will use HuggingFace default
    train_mode: "full"  # or "lora"
    lora_config:
      rank: 4
      alpha: 8
      dropout: 0.1

# Losses
losses:
  # Reconstruction
  reconstruction:
    type: "mel_l2"
    weight: 1.0

  # Structure preservation
  structure:
    heads: ["rhythm", "harmony", "energy"]
    weights:
      rhythm: 1.0
      harmony: 1.0
      energy: 1.0
    metrics:
      rhythm: "onset_correlation"
      harmony: "chroma_cosine"
      energy: "rms_correlation"

  # Rank consistency
  rank:
    type: "spearman"
    weight: 1.0  # Will be adjusted per phase

# Metrics
metrics:
  compute_every_n_steps: 50
  metrics_list:
    - "mel_l2"
    - "onset_correlation"
    - "chroma_cosine"
    - "rms_correlation"
    - "rank_spearman"

# Output
output:
  save_s_encoder: true
  save_generator: true
  save_statistics: true  # S_proxy statistics
  output_path: "${project.checkpoint_dir}/stage1"
  statistics_file: "S_proxy_statistics.pt"

# Validation
validation:
  val_split: 0.1
  val_every_n_epochs: 5
  metrics:
    min_rank_spearman: 0.7
    min_onset_correlation: 0.5
